============================= test session starts =============================
platform win32 -- Python 3.14.0, pytest-9.0.2, pluggy-1.6.0
rootdir: C:\Users\dd\Projects\agproject\unity-mcp-ide\MCPForUnity\Server~\tests
configfile: pytest.ini
plugins: anyio-4.12.0, asyncio-1.3.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 6 items

tests\integration\test_manage_asset_json_parsing.py DEBUG: Captured logs: ['manage_asset: received properties as string (first 100 chars): {"shader": "Universal Render Pipeline/Lit", "color": [0, 0, 1, 1]}', 'manage_asset: coerced properties from JSON string to dict']
F.....

================================== FAILURES ===================================
_______ TestManageAssetJsonParsing.test_properties_json_string_parsing ________

self = <tests.integration.test_manage_asset_json_parsing.TestManageAssetJsonParsing object at 0x00000208F2193250>
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x00000208F22542B0>

    @pytest.mark.asyncio
    async def test_properties_json_string_parsing(self, monkeypatch):
        """Test that JSON string properties are correctly parsed to dict."""
        # Mock context
        ctx = DummyContext()
    
        # Patch Unity transport
        async def fake_async(cmd, params, **kwargs):
            return {"success": True, "message": "Asset created successfully", "data": {"path": "Assets/Test.mat"}}
        monkeypatch.setattr(
            "services.tools.manage_asset.async_send_command_with_retry", fake_async)
    
        # Test with JSON string properties
        result = await manage_asset(
            ctx=ctx,
            action="create",
            path="Assets/Test.mat",
            asset_type="Material",
            properties='{"shader": "Universal Render Pipeline/Lit", "color": [0, 0, 1, 1]}'
        )
    
        # Verify JSON parsing was logged
        print(f"DEBUG: Captured logs: {ctx.log_info}")
>       assert any(
            "manage_asset: coerced properties using centralized parser" in msg
            for msg in ctx.log_info
        )
E       assert False
E        +  where False = any(<generator object TestManageAssetJsonParsing.test_properties_json_string_parsing.<locals>.<genexpr> at 0x00000208F13D3100>)

tests\integration\test_manage_asset_json_parsing.py:37: AssertionError
=========================== short test summary info ===========================
FAILED tests\integration\test_manage_asset_json_parsing.py::TestManageAssetJsonParsing::test_properties_json_string_parsing
========================= 1 failed, 5 passed in 0.44s =========================
